{% extends "layouts/layout.html" %}
{% block page_title %}WRA Prototype Kit index{% endblock %}

{% block headEnd %}
<script src="https://unpkg.com/maplibre-gl@1.14.0-rc.1/dist/maplibre-gl.js"></script>
<link href="https://unpkg.com/maplibre-gl@1.14.0-rc.1/dist/maplibre-gl.css" rel="stylesheet" />
{% endblock headEnd %}

{% block content %}
<main id="content" role="main">

  <span class="app-caption wra-!-margin-top-9">Pinpoint a location</span>
  <h1 class="h1-sm-and-up">Find your local authority</h1>

  <div class="row">
    <div class="col-lg-8">
      <p>Select your location by clicking on the map. A marker will appear where you have clicked on the map.</p>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-8">
      <div id="mapId" style="min-height: 600px;"></div>
    </div>
    <div class="col-lg-4">
      <div class="app-information-panel">
        <h2 class="wra-!-margin-top-0 wra-!-margin-bottom-3">Location details</h2>
        <dl>
          <div class="app-dl-item">
            <dt>Latitude</dt>
            <dd class="app-dynamic-latitude app-no-value">No location selected</dd>
          </div>
          <div class="app-dl-item">
            <dt>Longitude</dt>
            <dd class="app-dynamic-longitude app-no-value">No location selected</dd>
          </div>
          <div class="app-dl-item">
            <dt>Local authority</dt>
            <dd class="app-dynamic-la-name app-no-value"></dd>
          </div>
          <div class="app-dl-item">
            <dt>Tax rate</dt>
            <dd class="app-no-value"></dd>
          </div>
        </dl>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-8">
      <hr class="app-break-xl" />
      <p>This proof of concept uses <a href="https://datamap.gov.wales/layergroups/inspire-wg:LocalAuthorities">local authority boundaries</a> from <a href="https://datamap.gov.wales/">DataMapWales</a>.</p>
      <p>We converted the coordinates from eastings and northings to wgs84 so that we could display the boundaries on the map.</p>
      <a href="/static/data/la_boundaries_wgs84.geojson" class="app-btn wra-!-margin-top-3">Download the geojson</a>
    </div>
  </div>
</main>
{% endblock %}

{% block pageScripts %}
<script>
  const createMap = function () {
    var map = new maplibregl.Map({
      container: "mapId",// container id
      style: "/static/javascripts/base-tile.json",
      center: [-3.7, 52.4], // starting position [lng, lat]
      zoom: 6.89// starting zoom
    });

    map.addControl(new maplibregl.FullscreenControl({
      container: document.querySelector(this.mapContainerSelector)
    }), 'bottom-left');
    return map;
  };

  const createMarker = function (colour) {
    const c = colour || "red" 
    return new maplibregl.Marker({ color: c })
  }

  function renderBoundaries(map) {
    fetch('/static/data/la_boundaries_wgs84.geojson')
    .then(response => response.json())
    .then(function(data) {
      console.log(data)
      map.addSource('laBoundaries', {
        'type': 'geojson',
        'data': '/static/data/la_boundaries_wgs84.geojson'
      })
      map.addLayer({
        'id': 'laLayer',
        'type': 'fill',
        'source': 'laBoundaries',
        'layout': {},
        'paint': {
          'fill-color': '#088',
          'fill-opacity': 0.4
        }
      });
      map.addLayer({
        'id': 'laLayerLine',
        'type': 'line',
        'source': 'laBoundaries',
        'layout': {},
        'paint': {
          'line-color': '#088',
          'line-opacity': 0.8,
          'line-width': 1
        }
      });
    });
  }

  const getLocalAuthorityFeatures = function (map, pt) {
    const features = map.queryRenderedFeatures(pt)
    return features.filter(feature => feature.layer.source === 'laBoundaries')
  }

  const map = createMap()
  const marker = createMarker()
  const $lat = document.querySelector('.app-dynamic-latitude')
  const $lng = document.querySelector('.app-dynamic-longitude')
  const $laName = document.querySelector('.app-dynamic-la-name')

  // add listener for when initial map loaded
  map.on('load', function(e) {
    console.log("map loaded")
    renderBoundaries(map)
  });
  // add listener for when map clicked on
  map.on('click', function(e) {
    console.log("map clicked on", e)
    console.log("click location", e.lngLat.lng, e.lngLat.lat)
    console.log("point", e.point)
    const boundaries = getLocalAuthorityFeatures(map, e.point)
    console.log("clicked on boundaries", boundaries)

    $lat.classList.remove("app-no-value")
    $lat.textContent = e.lngLat.lat
    $lng.classList.remove("app-no-value")
    $lng.textContent = e.lngLat.lng
    
    // need to handle no boundary returned
    $laName.classList.remove("app-no-value")
    $laName.textContent = boundaries[0].properties.name

    // put marker at point user clicked
    marker
      .setLngLat([e.lngLat.lng, e.lngLat.lat])
      .addTo(map)
  });


</script>
{% endblock pageScripts %}
